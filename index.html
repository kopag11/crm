<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalkulator CRM</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb; --primary-soft: #eff6ff;
            --bg-color: #f1f5f9; --card-bg: #ffffff; --text-dark: #1e293b;
            --text-gray: #64748b; --success: #10b981; --success-soft: #d1fae5;
            --warning: #f59e0b; --warning-soft: #fef3c7; --danger: #ef4444;
            --danger-soft: #fee2e2; --radius: 16px; --radius-sm: 12px;
            --shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.05);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-dark); margin: 0; padding: 0; min-height: 100vh; line-height: 1.5; }
        .container { width: 100%; max-width: 550px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        h1, h2, h3 { family: 'Poppins', sans-serif; margin: 0; color: var(--text-dark); }
        
        #qrOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #exitScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 10000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; }
        .pulse-icon { font-size: 4rem; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        #loginScreen {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 30px 25px; background: var(--card-bg);
            border-radius: var(--radius); box-shadow: var(--shadow); margin-top: 20px; margin-bottom: 20px;
        }
        .icon-circle { width: 70px; height: 70px; background: var(--primary-soft); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .icon-circle svg { width: 40px; height: 40px; }
        .login-note { background: var(--danger-soft); color: #b91c1c; padding: 12px 20px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; margin-bottom: 30px; display: inline-flex; align-items: center; gap: 8px; }
        .pin-wrapper input { font-family: 'Poppins', monospace; font-size: 2.2rem; width: 100%; max-width: 280px; text-align: center; letter-spacing: 12px; padding: 15px; border: 2px solid #e2e8f0; border-radius: var(--radius); background: #f8fafc; color: var(--text-dark); transition: all 0.3s ease; outline: none; text-transform: uppercase; }
        .pin-wrapper input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }
        .btn-main { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; padding: 18px; border-radius: 50px; font-weight: 600; font-size: 1rem; width: 100%; cursor: pointer; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.25); transition: transform 0.2s; margin-top: 20px; }
        
        #dashboard { display: none; padding-bottom: 60px; }
        .header-card { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 24px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); display: flex; justify-content: space-between; align-items: flex-start; }
        .store-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; letter-spacing: 1px; display: inline-block; }
        .btn-logout { background: rgba(255,255,255,0.9); color: var(--danger); border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid #f1f5f9; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: flex; align-items: center; font-size: 0.85rem; font-weight: 600; color: var(--text-gray); margin-bottom: 8px; text-transform: uppercase; }
        input { width: 100%; padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: var(--radius-sm); font-size: 1rem; background: #f8fafc; outline: none; }
        .highlight-card { background: var(--primary-soft); border: 1px solid #bfdbfe; }
        #total_sales { background: white; border-color: #93c5fd; color: var(--primary-dark); font-weight: 700; font-size: 1.4rem; text-align: center; }
        .input-with-btn { display: flex; gap: 10px; }
        .btn-add { background: var(--bg-color); color: var(--primary); border: 1px solid #e2e8f0; width: 55px; border-radius: var(--radius-sm); font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .summary-card { background: #1e293b; color: white; text-align: center; padding: 25px; border-radius: var(--radius); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; opacity: 0.9; }
        .status-box { padding: 15px; border-radius: 12px; font-weight: 700; font-size: 1.1rem; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .status-ok { background: var(--success); color: white; }
        .status-min { background: var(--danger); color: white; }
        .status-plus { background: #3b82f6; color: white; }
        .btn-action { width: 100%; padding: 18px; border: none; border-radius: var(--radius); font-weight: 700; font-size: 1rem; cursor: pointer; color: white; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .bg-blue { background: #0ea5e9; } .bg-green { background: var(--success); } .bg-yellow { background: var(--warning); color: #78350f; } .btn-wa { background: #25D366; display: none; margin-top:15px;}
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px 25px; border-radius: 24px; width: 85%; max-width: 350px; text-align: center;}
        .calc-row { display: flex; gap: 10px; margin-bottom: 10px; text-align: left;}
        .btn-remove { background: var(--danger-soft); color: var(--danger); border: none; width: 45px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }
        .check-tertelan-wrapper { display: inline-flex; align-items: center; margin-left: 8px; background: #f1f5f9; padding: 2px 8px; border-radius: 6px; border: 1px solid #cbd5e1; }
        .info-btn { width:20px; height:20px; border-radius:50%; background:#e0f2fe; color:#0284c7; display:inline-flex; align-items:center; justify-content:center; font-size:10px; margin-left:5px; cursor:pointer;}
        .btn-draft { background: white; color: var(--danger); border: 1px solid var(--danger-soft); width: 100%; padding: 12px; border-radius: var(--radius-sm); margin-bottom: 20px; font-weight:600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        #historyList { font-size: 0.85rem; color: #b45309; padding: 15px; background: #fffbeb; border-radius: 12px; margin-bottom: 20px; border: 1px solid #fcd34d; display: none; text-align: left;}
    </style>
</head>
<body>

<div id="qrOverlay">
    <div class="pulse-icon">‚è≥</div>
    <h3 style="color:var(--primary); margin-bottom:5px;">Sedang Memverifikasi...</h3>
</div>

<div id="exitScreen">
    <div style="font-size: 4rem; margin-bottom: 20px;">üëã</div>
    <h2>Berhasil Keluar</h2>
    <button onclick="window.close()" style="background:var(--text-gray); color:white; border:none; padding:12px 25px; border-radius:50px; margin-top:20px;">Tutup Halaman</button>
</div>

<div class="container">
    
    <div id="loginScreen">
        <div style="margin-bottom: 20px;">
            <div class="icon-circle">
                <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><path style="fill:#F5C86E;" d="M434,230H78c-21.085,0-38.697-14.835-42.991-34.634L34,195.289V458c0,24.301,19.699,44,44,44h360 c22.091,0,40-17.909,40-40V319.323V274C478,249.699,458.301,230,434,230z"/><path style="fill:#6E87F5;" d="M374.788,142H438c22.091,0,40,17.909,40,40v92v45.323V274c0-24.301-19.699-44-44-44H78 c-24.301,0-44-19.699-44-44l0,0c0-24.301,19.699-44,44-44H78 c-24.301,0-44-19.699-44-44l0,0c0-24.301,19.699-44,44-44h59.454H374.788z"/><g><circle style="fill:#4BB9F5;" cx="110" cy="365.83" r="20"/><circle style="fill:#4BB9F5;" cx="217.29" cy="355.13" r="20"/></g><g><circle style="fill:#FF5A5A;" cx="200.62" cy="445.83" r="20"/><circle style="fill:#FF5A5A;" cx="281.12" cy="286.83" r="20"/></g><path style="fill:#F5C86E;" d="M325.599,186c7.174-12.068,11.307-26.156,11.307-41.215c0-44.617-36.169-80.785-80.785-80.785 s-80.785,36.169-80.785,80.785c0,15.059,4.133,29.147,11.307,41.215H325.599z"/><path style="fill:#FAE196;" d="M478,409.084H359.539c-24.301,0-44-19.699-44-44l0,0c0-24.3,19.699-44,44-44H478"/><path d="M438,132h-63.212c-5.522,0-10,4.477-10,10s4.478,10,10,10H438c16.542,0,30,13.458,30,30v50.088 C458.71,224.537,446.876,220,434,220H78c-18.748,0-34-15.252-34-34s15.252-34,34-34h59.454c5.522,0,10-4.477,10-10s-4.478-10-10-10 H78c-29.775,0-54,24.224-54,54c0,2.198,0,272,0,272c0,29.776,24.225,54,54,54h360c27.57,0,50-22.43,50-50V182 C488,154.43,465.57,132,438,132z M468,399.084H359.539c-18.748,0-34-15.252-34-34s15.252-34,34-34H468V399.084z M438,492H78 c-18.748,0-34-15.252-34-34v-41.169h14.524l36.071,36.071c1.876,1.875,4.419,2.929,7.071,2.929h70.676 c4.128,11.639,15.243,20,28.28,20c16.542,0,30-13.458,30-30s-13.458-30-30-30c-13.036,0-24.152,8.361-28.28,20H105.81L69.739,399.76 c-1.876-1.875-4.419-2.929-7.071-2.929H44v-21.746h37.467c3.91,12.026,15.219,20.746,28.533,20.746c16.542,0,30-13.458,30-30 s-13.458-30-30-30c-12.756,0-23.671,8.006-28.002,19.254H44v-19.254h18.667c2.652,0,5.195-1.054,7.071-2.929l36.071-36.071h147.032 c4.128,11.639,15.244,20,28.28,20c16.542,0,30-13.458,30-30s-13.458-30-30-30c-13.036,0-24.152,8.361-28.28,20H101.667 c-2.652,0-5.195,1.054-7.071,2.929l-36.071,36.071H44v-87.918C53.29,235.463,65.123,240,78,240h356c18.748,0,34,15.252,34,34v37.084 H359.539c-29.775,0-54,24.224-54,54s24.225,54,54,54H468V448h-54.379c-5.522,0-10,4.477-10,10s4.478,10,10,10h53.775 C464.609,481.677,452.488,492,438,492z M190.623,445.831c0-5.514,4.486-10,10-10s10,4.486,10,10s-4.486,10-10,10 S190.623,451.345,190.623,445.831z M100,365.831c0-5.514,4.486-10,10-10s10,4.486,10,10s-4.486,10-10,10S100,371.345,100,365.831z M271.121,286.831c0-5.514,4.486-10,10-10s10,4.486,10,10s-4.486,10-10,10S271.121,292.345,271.121,286.831z"/></svg>
            </div>
            <h2>Kalkulator CRM</h2>
            <p style="color: var(--text-gray); margin: 5px 0 0 0;">Input Struk setoran</p>
        </div>
        
        <div class="login-note"><span>üìç</span> Wajib berada di lokasi toko</div>
        <div class="pin-wrapper"><input type="text" id="inputKode" maxlength="4" placeholder="KODE TOKO"></div>
        
        <button id="btnLogin" class="btn-main" onclick="doLogin()">MASUK SEKARANG</button>
        <p id="gpsStatus" style="font-size:0.85rem; color:var(--text-gray); margin-top:25px;">‚è≥ System Ready</p>
    </div>

    <div id="dashboard">
        <div class="header-card">
            <div class="store-info">
                <span style="font-size:0.8rem; opacity:0.9; margin-bottom:5px; display:block;">Selamat Datang,</span>
                <h2 id="displayNama">Nama Toko</h2>
                <div style="margin-top: 8px;"><span class="store-badge" id="displayKode">CODE</span></div>
            </div>
            <button class="btn-logout" onclick="logout()">Keluar ‚ûî</button>
        </div>

        <div id="historyList">Loading...</div>
        <button type="button" class="btn-draft" onclick="confirmDeleteDraft()">
            <span>üóëÔ∏è</span> Hapus Draf di Cloud
        </button>

        <form id="salesForm">
            <input type="hidden" name="Kode Toko" id="formKode">
            <input type="hidden" name="Info Perangkat" id="info_perangkat">
            
            <div class="card">
                <div class="form-group">
                    <label>üìÖ Tanggal Sales</label>
                    <input type="date" name="Tanggal" id="tgl" required onchange="validateDateChange(this)"> </div>
                <div class="form-group">
                    <label>üè™ Nama Toko</label>
                    <input type="text" name="Nama Toko" id="nama_toko" readonly style="background:#f1f5f9; color:#64748b; font-weight: 500;"> 
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label>üì± Nomor WA Anda</label>
                    <input type="tel" id="nomor_pengirim" placeholder="08xxxxxxx" onchange="saveSender(this.value)">
                </div>
            </div>

            <div class="card highlight-card">
                <div class="form-group" style="margin-bottom:0;">
                    <label style="color:var(--primary-dark); text-align: center; width: 100%;">üí∞ TOTAL SALES TUTUPAN (Rp)</label>
                    <input type="text" inputmode="numeric" name="Total Sales" id="total_sales" placeholder="0" onkeyup="formatRibuan(this); hitungGlobal();">
                </div>
            </div>

            <div id="dynamicInputs"></div>

            <div class="card summary-card">
                <div class="summary-row"><span>Total Uang Fisik</span><span id="disp_total_fisik" style="font-weight:600;">Rp 0</span></div>
                <div class="summary-row"><span>Total Potongan</span><span id="disp_total_potong" style="font-weight:600;">Rp 0</span></div>
                <div class="summary-divider"></div>
                <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 5px;">Status Akhir:</div>
                <div id="disp_balance" class="status-box status-ok">
                    <span>‚úÖ</span> 0
                </div>
            </div>

            <input type="hidden" id="h_total_fisik" value="0"><input type="hidden" id="val_nama_ekor"><input type="hidden" id="val_selisih" value="0">

            <button type="button" class="btn-action btn-blue" id="btn-submit" onclick="processSubmit()">
                <span>‚òÅÔ∏è</span> SIMPAN KE DATABASE
            </button>
            <button type="button" class="btn-action btn-wa" id="btn-wa" onclick="kirimWA()">
                <span>üì≤</span> KIRIM KE WHATSAPP
            </button>
            
            <p id="status" style="text-align:center; margin-top:20px; font-weight:600; color:var(--text-gray);"></p>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <span id="confirmIcon" class="modal-icon">‚ö†Ô∏è</span>
        <div id="confirmTitle" class="modal-title">Konfirmasi</div>
        <div id="confirmMsg" class="modal-text">Pesan konfirmasi...</div>
        <div class="modal-footer"><button class="btn-modal-cancel" onclick="closeConfirm()">Batal</button><button id="btnConfirmYes" class="btn-modal-primary" onclick="doConfirmYes()">Ya, Lanjutkan</button></div>
    </div>
</div>
<div id="alertModal" class="modal">
    <div class="modal-content"><span class="modal-icon">‚ÑπÔ∏è</span><div class="modal-title" id="alertTitle">Info</div><div class="modal-text" id="alertMsg">Message</div><button class="btn-modal-primary" style="width:100%" onclick="document.getElementById('alertModal').style.display='none'">OK, Mengerti</button></div>
</div>
<div id="calcModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-bottom:20px; color:var(--primary);">Rincian</h3>
        <div id="calcList" style="max-height:250px; overflow-y:auto; margin-bottom:15px; padding-right: 5px;"></div>
        <button onclick="addCalcRow()" style="background:#f8fafc; color:var(--primary); border:2px dashed #cbd5e1; padding:12px; width:100%; border-radius:12px; font-weight: 600; margin-bottom: 15px;">+ Tambah Struk</button>
        <div style="background: var(--primary-soft); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><span style="font-size: 0.9rem; color: var(--text-gray);">Total:</span><strong id="modalTotal" style="color:var(--primary); font-size: 1.1rem;">0</strong></div>
        <div class="modal-footer"><button class="btn-modal-cancel" onclick="document.getElementById('calcModal').style.display='none'">Batal</button><button class="btn-modal-primary" onclick="saveCalculator()">Simpan Hasil</button></div>
    </div>
</div>

<script>
    //SEPTA GANTENG
    const SB_URL = 'https://mpzxceuhnuhhuvveppmh.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wenhjZXVobnVoaHV2dmVwcG1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNjQwNDEsImV4cCI6MjA4Mzg0MDA0MX0.sIRvchXgTH9kEMCqhuM2geYohe1TiipYgxz3PQ_y4R0';
    let supabase = null;

    let currentStoreCode = "";
    let dataStore = {}; 
    let activeField = "";
    let onConfirmAction = null;
    const MAX_RADIUS_METERS = 40; 

    window.addEventListener('load', function() {
        try { 
            supabase = window.supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession: false } }); 
        } catch(e) { console.error(e); }

        initForm(); 
        
        getDetailedDeviceInfo();
        if(localStorage.getItem('crm_sender_phone')) document.getElementById('nomor_pengirim').value = localStorage.getItem('crm_sender_phone');
        document.getElementById('tgl').value = getYesterdayDate();
        hitungGlobal();
        
        const urlParams = new URLSearchParams(window.location.search);
        const qrKode = urlParams.get('kode');
        
        if (qrKode) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('qrOverlay').style.display = 'flex';
            document.getElementById('inputKode').value = qrKode.toUpperCase();
            setTimeout(() => doLogin(true, true), 500); 
        } else {
            let sess = localStorage.getItem('crm_sess');
            if(sess) {
                let p = sess.split('|');
                masukDashboard(p[0], p[1], p[2]);
            }
        }
    });

    async function doLogin(bypassGPS = false, isSilent = false) {
        const k = document.getElementById('inputKode').value.toUpperCase().trim();
        const btn = document.getElementById('btnLogin');
        const stat = document.getElementById('gpsStatus');

        if (!k) return alert("Isi Kode!");
        if (k === "COBA") return masukDashboard("COBA", "TEST", "Toko Uji Coba");

        if(!isSilent) {
            btn.disabled = true; 
            btn.innerText = "‚è≥ Mengecek...";
            stat.innerText = "Menghubungi Server...";
        }

        try {
            let { data, error } = await supabase
                .from('tb_toko')
                .select('*')
                .eq('kode', k)
                .single();

            if (error || !data) throw new Error("Kode Toko Tidak Ditemukan.");

            if (bypassGPS) {
                masukDashboard(k, k, data.nama);
                return;
            }

            stat.innerText = "Memverifikasi Lokasi...";
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    let d = calculateDistance(pos.coords.latitude, pos.coords.longitude, data.lat, data.lon);
                    if (d > MAX_RADIUS_METERS) {
                        alert(`Lokasi Jauh! Jarak ${Math.round(d)}m.`);
                        btn.disabled=false; btn.innerText="MASUK SEKARANG";
                    } else {
                        masukDashboard(k, k, data.nama);
                    }
                },
                (err) => {
                    if(confirm("GPS Bermasalah. Lanjutkan Masuk?")) {
                        masukDashboard(k, k, data.nama);
                    } else {
                        btn.disabled=false; btn.innerText="MASUK SEKARANG";
                    }
                },
                { timeout: 5000 } 
            );

        } catch(e) {
            if(!isSilent) {
                alert(e.message);
                btn.disabled = false; btn.innerText = "MASUK SEKARANG";
                document.getElementById('qrOverlay').style.display='none';
                document.getElementById('loginScreen').style.display='flex';
            }
        }
    }

    function masukDashboard(kode, disp, nama) {
        currentStoreCode = kode;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('qrOverlay').style.display = 'none'; 
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('displayKode').innerText = disp;
        document.getElementById('displayNama').innerText = nama;
        document.getElementById('nama_toko').value = nama;
        document.getElementById('formKode').value = kode;
        localStorage.setItem('crm_sess', kode + '|' + disp + '|' + nama);
        loadDraft();
    }

    function logout() { localStorage.removeItem('crm_sess'); location.reload(); }

    function initForm() {
        const f1 = [{id:'setor_sore', l:'‚òÄÔ∏è Setor Sore', d:'Sales H-1'},{id:'setor_malam', l:'üåô Setor Malam', d:'21.00-24.00'},{id:'setor_pagi', l:'üåÖ Setor Pagi', d:'24.00-Selesai'},{id:'ekor_sales', l:'ü™ô Ekor Sales', d:'Transfer', n:true}];
        const f2 = [{id:'pot_ba', l:'‚ö†Ô∏è Potongan BA', d:'Varian'},{id:'pot_lebih', l:'‚ûï Potongan Lebih', d:'Tertelan', c:true},{id:'pot_virtual', l:'üí≥ Potongan Virtual', d:'Koreksi'}];
        let h = `<div class="card"><div class="section-title t-fisik"><span>üíµ</span> Uang Fisik</div>`;
        f1.forEach(f=>h+=createFieldHtml(f)); h+=`</div><div class="card"><div class="section-title t-potong"><span>‚úÇÔ∏è</span> Potongan</div>`;
        f2.forEach(f=>h+=createFieldHtml(f)); h+=`</div>`; document.getElementById('dynamicInputs').innerHTML=h;
    }
    function createFieldHtml(f) {
        if(!dataStore[f.id]) dataStore[f.id]=[];
        let note = f.n?`<input type="text" id="note_ekor" placeholder="Ket. Ekor" value="${document.getElementById('val_nama_ekor')?document.getElementById('val_nama_ekor').value:''}" oninput="document.getElementById('val_nama_ekor').value=this.value;autoSaveDraft()" style="margin-top:10px; border:1px dashed #cbd5e1; background:#f8fafc">`:'';
        let chk = f.c?`<div class="check-tertelan-wrapper"><input type="checkbox" id="check_tertelan" onchange="autoSaveDraft()"><label for="check_tertelan" style="margin-left:5px; font-size:0.8rem">Tertelan?</label></div>`:'';
        let info = f.d?`<span class="info-btn" onclick="showAlert('Info','${f.d}')">i</span>`:'';
        return `<div class="form-group"><label>${f.l} ${info} ${chk}</label><div class="input-with-btn"><input type="text" id="view_${f.id}" value="Rp 0" readonly><button class="btn-add" onclick="openCalc('${f.id}','${f.l}')">+</button></div>${note}</div>`;
    }
    function openCalc(id,t) { activeField=id; document.getElementById('modalTitle').innerText=t; document.getElementById('calcModal').style.display='flex'; renderCalcRows(); updateModalTotal(); }
    function renderCalcRows() { const c=document.getElementById('calcList'); c.innerHTML=""; (dataStore[activeField]||[]).forEach((v,i)=>{ c.innerHTML+=`<div class="calc-row"><input class="calc-input" value="${v==0?'':v.toLocaleString('id-ID')}" onkeyup="formatRibuan(this);updateModalTotal()" onblur="handleBlur(this)"><button class="btn-remove" onclick="removeRow(${i})">‚úï</button></div>`; }); }
    function addCalcRow() { if(!dataStore[activeField]) dataStore[activeField]=[]; dataStore[activeField].push(0); renderCalcRows(); }
    function removeRow(i) { dataStore[activeField].splice(i,1); renderCalcRows(); updateModalTotal(); }
    function updateModalTotal() { let t=0; document.querySelectorAll('.calc-input').forEach(i=>t+=getCleanNumber(i.value)); document.getElementById('modalTotal').innerText="Rp "+t.toLocaleString('id-ID'); }
    function saveCalculator() { updateModalTotal(); let t=dataStore[activeField].reduce((a,b)=>a+b,0); document.getElementById('view_'+activeField).value="Rp "+t.toLocaleString('id-ID'); if(document.getElementById('h_'+activeField)) document.getElementById('h_'+activeField).value=t; document.getElementById('calcModal').style.display='none'; hitungGlobal(); }
    function handleBlur(el) { dataStore[activeField]=Array.from(document.querySelectorAll('.calc-input')).map(i=>getCleanNumber(i.value)); }
    
    function hitungGlobal() {
        let sales=getCleanNumber(document.getElementById('total_sales').value);
        let fisik=0; ['setor_sore','setor_malam','setor_pagi','ekor_sales'].forEach(k=>fisik+=Number(dataStore[k]?dataStore[k].reduce((a,b)=>a+b,0):0));
        let potong=0; ['pot_ba','pot_lebih','pot_virtual'].forEach(k=>potong+=Number(dataStore[k]?dataStore[k].reduce((a,b)=>a+b,0):0));
        
        document.getElementById('disp_total_fisik').innerText="Rp "+fisik.toLocaleString('id-ID');
        document.getElementById('disp_total_potong').innerText="Rp "+potong.toLocaleString('id-ID');
        document.getElementById('h_total_fisik').value=fisik;
        
        let sel=(fisik+potong)-sales; 
        document.getElementById('val_selisih').value=sel;
        let el=document.getElementById('disp_balance'); let btn=document.getElementById('btn-submit');
        
        if(sel===0) { el.innerHTML="‚úÖ BALANCE"; el.className="status-box status-ok"; btn.className="btn-action btn-green"; btn.innerHTML="üíæ SIMPAN DATABASE"; }
        else if(sel<0) { el.innerHTML="‚ö†Ô∏è KURANG "+Math.abs(sel).toLocaleString('id-ID'); el.className="status-box status-min"; btn.className="btn-action btn-yellow"; btn.innerHTML="‚ö†Ô∏è SIMPAN DATABASE (MINUS)"; }
        else { el.innerHTML="‚ûï LEBIH "+sel.toLocaleString('id-ID'); el.className="status-box status-plus"; btn.className="btn-action btn-blue"; btn.innerHTML="‚ÑπÔ∏è SIMPAN DATABASE (LEBIH)"; }
        autoSaveDraft();
    }

    async function processSubmit() {
        let btn = document.getElementById('btn-submit');
        if (!document.getElementById('tgl').value) return alert("Pilih Tanggal!");
        
        btn.disabled = true; btn.innerText = "‚è≥ Menyimpan...";
        
        try {
            if(!supabase) throw new Error("Supabase gagal dimuat.");
            
            let tgl = document.getElementById('tgl').value;
            let payload = {
                kode_toko: currentStoreCode, nama_toko: document.getElementById('nama_toko').value,
                tgl_sales: tgl, total_sales: getCleanNumber(document.getElementById('total_sales').value),
                total_fisik: Number(document.getElementById('h_total_fisik').value),
                total_potongan: getCleanNumber(document.getElementById('disp_total_potong').innerText),
                selisih: Number(document.getElementById('val_selisih').value), pengirim: document.getElementById('nomor_pengirim').value
            };

            await supabase.from('rincian_sales').delete().eq('kode_toko', currentStoreCode).eq('tgl_sales', tgl);
            await supabase.from('laporan_sales').upsert(payload, { onConflict: 'kode_toko, tgl_sales' });

            let rin = [];
            const map = {'setor_sore':'Setor Sore','setor_malam':'Setor Malam','setor_pagi':'Setor Pagi','ekor_sales':'Ekor Sales','pot_ba':'Potongan BA','pot_lebih':'Potongan Lebih','pot_virtual':'Potongan Virtual'};
            for(let k in map) {
                if(dataStore[k]) dataStore[k].forEach(v => {
                    if(v>0) {
                        let ket = k==='ekor_sales' ? document.getElementById('val_nama_ekor').value : (k==='pot_lebih'&&document.getElementById('check_tertelan').checked?"Tertelan":"");
                        rin.push({ kode_toko:currentStoreCode, tgl_sales:tgl, kategori:map[k], nominal:v, keterangan:ket, cek_manual_saldo:null });
                    }
                });
            }
            if(rin.length > 0) await supabase.from('rincian_sales').insert(rin);

            alert("‚úÖ Berhasil Simpan!"); 
            hapusDraft(true); 
            kirimWA();
            btn.disabled = false; btn.innerText="‚òÅÔ∏è SIMPAN DATABASE"; 
        } catch(e) { 
            alert("Gagal Simpan: " + e.message); 
            btn.disabled=false; btn.innerText="‚òÅÔ∏è SIMPAN DATABASE"; 
        }
    }

    function kirimWA() {
        let tgl = document.getElementById('tgl').value.split('-');
        let sel = Number(document.getElementById('val_selisih').value);
        let stat = sel===0?"BALANCE":(sel>0?"LEBIH":"KURANG");
        let txt = `*LAPORAN SALES*\n*${currentStoreCode} - ${document.getElementById('nama_toko').value}*\nTgl: ${tgl[2]}-${tgl[1]}-${tgl[0]}\nTotal Sales: Rp ${document.getElementById('total_sales').value}\n\n*STATUS: ${stat}*\nSelisih: Rp ${sel.toLocaleString('id-ID')}\n\nPengirim: ${document.getElementById('nomor_pengirim').value}`;
        window.open(`https://wa.me/6285183347653?text=${encodeURIComponent(txt)}`, '_blank');
        location.reload();
    }

    async function autoSaveDraft() { if(!currentStoreCode) return; let d={tgl:document.getElementById('tgl').value, sales:document.getElementById('total_sales').value, data:dataStore, ekor:document.getElementById('val_nama_ekor')?document.getElementById('val_nama_ekor').value:''}; await supabase.from('tb_draft').upsert({ kode_toko: currentStoreCode, draft_data: d }); }
    async function loadDraft() { 
        document.getElementById('historyList').style.display='block'; document.getElementById('historyList').innerText="üîÑ Cek Draft..."; 
        let { data } = await supabase.from('tb_draft').select('draft_data').eq('kode_toko', currentStoreCode).single(); 
        if(data && data.draft_data){ 
            let d=data.draft_data; document.getElementById('total_sales').value=d.sales; if(d.data) dataStore=d.data; 
            ['setor_sore','setor_malam','setor_pagi','ekor_sales','pot_ba','pot_lebih','pot_virtual'].forEach(k=>{ 
                let v=(dataStore[k]||[]).reduce((a,b)=>a+b,0); 
                if(document.getElementById('view_'+k)) document.getElementById('view_'+k).value="Rp "+v.toLocaleString('id-ID'); 
            }); 
            if(d.ekor && document.getElementById('note_ekor')) document.getElementById('note_ekor').value=d.ekor; 
            hitungGlobal(); document.getElementById('historyList').innerText="‚úÖ Draft Pulih"; 
        } else document.getElementById('historyList').style.display='none'; 
    }
    async function confirmDeleteDraft() { if(confirm("Hapus?")){ await supabase.from('tb_draft').delete().eq('kode_toko', currentStoreCode); location.reload(); } }
    async function hapusDraft(silent) { await supabase.from('tb_draft').delete().eq('kode_toko', currentStoreCode); if(!silent) location.reload(); }

    function saveSender(v) { localStorage.setItem('crm_sender_phone', v); }
    function showAlert(t,m){ document.getElementById('alertTitle').innerText=t; document.getElementById('alertMsg').innerText=m; document.getElementById('alertModal').style.display='flex'; }
    function showConfirm(t,m,d,c){ document.getElementById('confirmTitle').innerText=t; document.getElementById('confirmMsg').innerText=m; onConfirmAction=c; document.getElementById('confirmModal').style.display='flex'; }
    function closeConfirm(){ document.getElementById('confirmModal').style.display='none'; }
    function doConfirmYes(){ if(onConfirmAction) onConfirmAction(); closeConfirm(); }
    function validateDateChange() { autoSaveDraft(); }
    function formatRibuan(e) { let v=e.value.replace(/[^0-9]/g,''); e.value=v?Number(v).toLocaleString('id-ID'):''; dataStore[activeField]=Array.from(document.querySelectorAll('.calc-input')).map(i=>getCleanNumber(i.value)); }
    function getCleanNumber(v) { return Number(v.toString().replace(/\./g,''))||0; }
    function getYesterdayDate() { let d=new Date(); d.setDate(d.getDate()-1); return d.toISOString().split('T')[0]; }
    async function getDetailedDeviceInfo() { document.getElementById('info_perangkat').value = navigator.userAgent; }
    function calculateDistance(lat1,lon1,lat2,lon2) { const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
</script>
</body>
</html>
