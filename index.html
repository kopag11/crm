<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --radius: 16px; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }
        .container { max-width: 550px; margin: 0 auto; }
        
        #loginScreen { display: block; background: var(--card); padding: 40px 25px; border-radius: var(--radius); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-top: 20px; }
        .input-pin { font-size: 2rem; width: 100%; text-align: center; letter-spacing: 5px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; margin: 20px 0; background: #f8fafc; text-transform: uppercase; }
        .btn-main { background: #3b82f6; color: white; border: none; padding: 18px; border-radius: 50px; font-weight: 600; width: 100%; font-size: 1rem; cursor: pointer; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); }
        .btn-main:active { transform: scale(0.98); }
        
        #dashboard { display: none; padding-bottom: 50px; }
        .header { background: #3b82f6; color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card { background: white; padding: 20px; border-radius: var(--radius); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; margin-top: 5px; background: #f8fafc; font-size: 1rem; }
        
        .btn-act { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; color: white; margin-top: 10px; cursor: pointer; }
        .bg-blue { background: #0ea5e9; } .bg-green { background: #10b981; } .bg-red { background: #ef4444; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
        #debugLog { display:none; background:#fee2e2; color:#b91c1c; padding:10px; font-size:0.8rem; margin-bottom:10px; border-radius:8px; text-align:left; word-break:break-all;}
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
    <div id="debugLog"></div>

    <div id="loginScreen">
        <div style="font-size:3rem; margin-bottom:10px;">‚ö°</div>
        <h2>CRM V8</h2>
        <p style="color:#64748b;">Versi Anti-Stuck</p>
        
        <input type="text" id="inputKode" class="input-pin" placeholder="KODE" maxlength="4">
        
        <button id="btnLogin" class="btn-main" onclick="handleLoginClick()">MASUK APLIKASI</button>
        <p id="msg" style="margin-top:20px; color:#64748b; font-size:0.9rem;">System Ready</p>
    </div>

    <div id="dashboard">
        <div class="header">
            <div>
                <div style="font-size:0.8rem; opacity:0.8">Halo,</div>
                <h3 id="dispNama" style="margin:0;">Nama Toko</h3>
                <span id="dispKode" style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:6px; font-size:0.8rem;">CODE</span>
            </div>
            <button onclick="logout()" style="background:white; color:red; border:none; padding:8px 15px; border-radius:20px; font-weight:bold;">Keluar</button>
        </div>

        <button onclick="hapusDraft()" style="width:100%; padding:10px; border:1px solid #fca5a5; background:#fef2f2; color:#b91c1c; border-radius:12px; margin-bottom:15px;">üóëÔ∏è Hapus Draf Cloud</button>

        <div class="card">
            <label>üìÖ Tanggal Sales</label><input type="date" id="tgl" onchange="autoSave()">
            <label style="margin-top:10px; display:block;">üì± No. WA</label><input type="tel" id="wa" placeholder="08xxx" onchange="localStorage.setItem('crm_wa',this.value)">
        </div>

        <div class="card" style="background:#eff6ff; border:1px solid #bfdbfe; text-align:center;">
            <label style="color:#1d4ed8; font-weight:bold;">TOTAL SALES (Rp)</label>
            <input type="text" id="total_sales" placeholder="0" style="text-align:center; font-size:1.5rem; font-weight:bold;" onkeyup="formatRupiah(this); hitung();">
        </div>

        <div id="inputList"></div>

        <div class="card" style="background:#1e293b; color:white; text-align:center;">
            <div style="display:flex; justify-content:space-between;"><span>Total Fisik</span><b id="txtFisik">0</b></div>
            <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>Total Potong</span><b id="txtPotong">0</b></div>
            <hr style="opacity:0.2; margin:15px 0;">
            <div id="statusBox" style="padding:10px; background:#10b981; border-radius:8px; font-weight:bold;">‚úÖ BALANCE</div>
        </div>

        <input type="hidden" id="nama_toko"><input type="hidden" id="real_kode">
        <input type="hidden" id="val_fisik" value="0"><input type="hidden" id="val_selisih" value="0">
        
        <button id="btnSimpan" class="btn-act bg-blue" onclick="kirimDatabase()">‚òÅÔ∏è SIMPAN DATABASE</button>
        <button class="btn-act bg-green" onclick="kirimWA()">üì≤ KIRIM WA</button>
        <p id="dbStatus" style="text-align:center; margin-top:10px; color:gray; font-size:0.9rem;"></p>
    </div>
</div>

<div id="modalAlert" class="modal"><div class="modal-box"><h3 id="alertTitle">Info</h3><p id="alertMsg"></p><button onclick="document.getElementById('modalAlert').style.display='none'" class="btn-act bg-blue">OK</button></div></div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzX8YNW9U6fyuCzBOWB_lcu7FDJS5ivTOI5RU2QBAVQz-sW_ov4ys_CSuqxQNnYDQLT/exec';
    const SUPABASE_URL = 'https://mpzxceuhnuhuhuveppmh.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wenhjZXVobnVoaHV2dmVwcG1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNjQwNDEsImV4cCI6MjA4Mzg0MDA0MX0.sIRvchXgTH9kEMCqhuM2geYohe1TiipYgxz3PQ_y4R0';
    
    let supabase = null;
    let dataStore = {}; 
    let activeCode = "";

    window.onerror = function(msg, url, line) {
        document.getElementById('debugLog').style.display = 'block';
        document.getElementById('debugLog').innerHTML += `‚ùå Error: ${msg} (Line ${line})<br>`;
        document.getElementById('btnLogin').innerText = "Refresh Halaman";
        document.getElementById('btnLogin').onclick = () => location.reload();
    };

    window.onload = function() {
        document.getElementById('tgl').value = new Date(new Date()-864e5).toISOString().split('T')[0]; // H-1
        if(localStorage.getItem('crm_wa')) document.getElementById('wa').value = localStorage.getItem('crm_wa');
        
        renderInputs();
        
        let sess = localStorage.getItem('crm_sess');
        if(sess) {
            let parts = sess.split('|');
            bukaDashboard(parts[0], parts[1]);
        }
    };

    function handleLoginClick() {
        let btn = document.getElementById('btnLogin');
        let msg = document.getElementById('msg');
        let kode = document.getElementById('inputKode').value.toUpperCase().trim();

        if(!kode) return alert("Masukkan Kode Toko!");
        
        if(kode === 'COBA') {
            bukaDashboard('COBA', 'Toko Uji Coba');
            return;
        }

        btn.disabled = true;
        btn.innerText = "‚è≥ Mengecek Server...";
        msg.innerText = "Sedang menghubungi Google Script...";

        fetch(SCRIPT_URL + "?action=get_shop_info&kode=" + kode)
        .then(res => res.json())
        .then(data => {
            if(data.error) {
                alert(data.error);
                btn.disabled = false;
                btn.innerText = "MASUK APLIKASI";
                msg.innerText = "Gagal Login";
            } else {
                bukaDashboard(kode, data.nama);
            }
        })
        .catch(err => {
            alert("Gagal Koneksi: " + err.message);
            btn.disabled = false;
            btn.innerText = "Coba Lagi";
            msg.innerText = "Error Koneksi";
        });
    }

    function bukaDashboard(kode, nama) {
        activeCode = kode;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('dispKode').innerText = kode;
        document.getElementById('dispNama').innerText = nama;
        document.getElementById('nama_toko').value = nama;
        document.getElementById('real_kode').value = kode;
        
        localStorage.setItem('crm_sess', kode + '|' + nama);
        loadDraft(); 
    }

    function logout() {
        localStorage.removeItem('crm_sess');
        location.reload();
    }

    function renderInputs() {
        const list = [
            {id:'setor_sore', l:'‚òÄÔ∏è Setor Sore', g:'fisik'},
            {id:'setor_malam', l:'üåô Setor Malam', g:'fisik'},
            {id:'setor_pagi', l:'üåÖ Setor Pagi', g:'fisik'},
            {id:'ekor_sales', l:'ü™ô Ekor Sales', g:'fisik', note:true},
            {id:'pot_ba', l:'‚ö†Ô∏è Potongan BA', g:'potong'},
            {id:'pot_lebih', l:'‚ûï Pot. Lebih/Tertelan', g:'potong', check:true},
            {id:'pot_virtual', l:'üí≥ Potongan Virtual', g:'potong'}
        ];

        let h = '';
        list.forEach(i => {
            if(!dataStore[i.id]) dataStore[i.id] = 0;
            let extra = i.note ? `<input type="text" id="note_${i.id}" placeholder="Nama Pengirim (Cth: Budi)" style="margin-top:5px; border:1px dashed #cbd5e1;">` : '';
            let check = i.check ? `<span style="float:right; font-size:0.8rem;"><input type="checkbox" id="check_${i.id}"> Tertelan?</span>` : '';
            
            h += `<div class="card" style="padding:15px;">
                    <label style="font-weight:bold; color:${i.g==='fisik'?'#3b82f6':'#ef4444'}">${i.l} ${check}</label>
                    <input type="text" id="inp_${i.id}" placeholder="0" onkeyup="formatRupiah(this); hitung();" style="font-weight:bold;">
                    ${extra}
                  </div>`;
        });
        document.getElementById('inputList').innerHTML = h;
    }


    function hitung() {
        let getVal = (id) => Number(document.getElementById(id).value.replace(/\./g,'')) || 0;
        let totalSales = getVal('total_sales');
        
        let fisik = 0, potong = 0;
        ['setor_sore','setor_malam','setor_pagi','ekor_sales'].forEach(k => fisik += getVal('inp_'+k));
        ['pot_ba','pot_lebih','pot_virtual'].forEach(k => potong += getVal('inp_'+k));
        
        document.getElementById('txtFisik').innerText = fisik.toLocaleString('id-ID');
        document.getElementById('txtPotong').innerText = potong.toLocaleString('id-ID');
        
        let selisih = (fisik + potong) - totalSales;
        document.getElementById('val_selisih').value = selisih;
        document.getElementById('val_fisik').value = fisik;

        let box = document.getElementById('statusBox');
        if(totalSales === 0) {
            box.innerText = "üìù ISI DATA DULU"; box.style.background = "#e2e8f0"; box.style.color = "black";
        } else if(selisih === 0) {
            box.innerText = "‚úÖ BALANCE (PAS)"; box.style.background = "#10b981"; box.style.color = "white";
        } else if(selisih > 0) {
            box.innerText = "‚ûï LEBIH Rp " + selisih.toLocaleString('id-ID'); box.style.background = "#3b82f6"; box.style.color = "white";
        } else {
            box.innerText = "‚ö†Ô∏è KURANG Rp " + Math.abs(selisih).toLocaleString('id-ID'); box.style.background = "#ef4444"; box.style.color = "white";
        }
        autoSave();
    }

    function formatRupiah(e) {
        let val = e.value.replace(/[^0-9]/g, '');
        e.value = Number(val).toLocaleString('id-ID');
        if(e.value === '0') e.value = '';
    }


    async function kirimDatabase() {
        let btn = document.getElementById('btnSimpan');
        let stat = document.getElementById('dbStatus');
        
        if(!document.getElementById('tgl').value) return alert("Pilih Tanggal!");
        
        btn.disabled = true; 
        btn.innerText = "üîÑ Menghubungkan...";
        
        try {
 
            if(!supabase) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            btn.innerText = "üöÄ Mengirim Data...";
            
 
            let getVal = (id) => Number(document.getElementById('inp_'+id).value.replace(/\./g,'')) || 0;
            let payload = {
                kode_toko: activeCode,
                nama_toko: document.getElementById('nama_toko').value,
                tgl_sales: document.getElementById('tgl').value,
                total_sales: Number(document.getElementById('total_sales').value.replace(/\./g,'')) || 0,
                total_fisik: Number(document.getElementById('val_fisik').value),
                total_potongan: Number(document.getElementById('txtPotong').innerText.replace(/\./g,'')) || 0,
                selisih: Number(document.getElementById('val_selisih').value),
                pengirim: document.getElementById('wa').value
            };

            await supabase.from('rincian_sales').delete().eq('kode_toko', activeCode).eq('tgl_sales', payload.tgl_sales);
            
            const { error } = await supabase.from('laporan_sales').upsert(payload, { onConflict: 'kode_toko, tgl_sales' });
            if(error) throw error;

            let rincian = [];
            const map = { 'setor_sore':'Setor Sore', 'setor_malam':'Setor Malam', 'setor_pagi':'Setor Pagi', 'ekor_sales':'Ekor Sales', 'pot_ba':'Potongan BA', 'pot_lebih':'Potongan Lebih', 'pot_virtual':'Potongan Virtual' };
            
            for(let k in map) {
                let v = getVal(k);
                if(v > 0) {
                    let ket = '';
                    if(k === 'ekor_sales') ket = document.getElementById('note_ekor').value;
                    if(k === 'pot_lebih' && document.getElementById('check_pot_lebih').checked) ket = "Tertelan";
                    
                    rincian.push({
                        kode_toko: activeCode,
                        tgl_sales: payload.tgl_sales,
                        kategori: map[k],
                        nominal: v,
                        keterangan: ket,
                        cek_manual_saldo: null
                    });
                }
            }
            if(rincian.length > 0) await supabase.from('rincian_sales').insert(rincian);

            stat.innerText = "‚úÖ Data Terbentuk";
            btn.innerText = "‚úÖ SUKSES";
            hapusDraft(true); /
            
            setTimeout(() => { 
                btn.disabled = false; btn.innerText = "‚òÅÔ∏è SIMPAN DATABASE"; 
                kirimWA();
            }, 1000);

        } catch(e) {
            console.error(e);
            alert("Gagal Simpan: " + e.message);
            btn.disabled = false;
            btn.innerText = "Coba Lagi";
        }
    }

   
    function kirimWA() {
        let tgl = document.getElementById('tgl').value.split('-');
        let tglIndo = `${tgl[2]}-${tgl[1]}-${tgl[0]}`;
        let wa = document.getElementById('wa').value;
        let selisih = Number(document.getElementById('val_selisih').value);
        let stat = selisih===0 ? "BALANCE OK ‚úÖ" : (selisih>0 ? `LEBIH (+) ${selisih.toLocaleString('id-ID')}` : `KURANG (-) ${Math.abs(selisih).toLocaleString('id-ID')}`);
        
        let txt = `*LAPORAN SETOR SALES*\n*${activeCode} - ${document.getElementById('nama_toko').value}*\nTgl: ${tglIndo}\nTotal Sales: Rp ${document.getElementById('total_sales').value}\n\n*STATUS: ${stat}*\n\nPengirim: ${wa}`;
        
 
        localStorage.removeItem('crm_sess');
        window.location.href = "https://wa.me/6285183347653?text=" + encodeURIComponent(txt);
    }

    function autoSave() {
    }
    
    function loadDraft() {
        fetch(SCRIPT_URL + "?action=load_draft&kode=" + activeCode)
        .then(r=>r.json()).then(d=>{
            if(d.total_sales) {
                document.getElementById('total_sales').value = Number(d.total_sales).toLocaleString('id-ID');
                hitung();
            }
        }).catch(e=>console.log("Draft skip"));
    }

    function hapusDraft(silent = false) {
        if(!silent && !confirm("Hapus draf?")) return;
        const fd = new FormData(); fd.append('action','delete_draft'); fd.append('Kode Toko', activeCode);
        fetch(SCRIPT_URL, {method:'POST', body:fd, mode:'no-cors'});
        if(!silent) location.reload();
    }
</script>

</body>
</html>
